<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 class="h2">Informasi Stok Bahan Ajar</h1>
</div>

<!-- Tambah stok baru -->
<p>
	<button class="btn btn-sm btn-primary me-2" @click="showAddModal = true"><i class="fas fa-plus"></i> Tambah Stok Baru</button>
	<button class="btn btn-sm btn-secondary" @click="resetFilters">Reset Filter & Sort</button>
</p>

<input type="text" v-model="filter" placeholder="Cari berdasarkan judul MK / kode" class="form-control mb-3" />

<!-- Filter dan Sort Controls -->
<div class="row mb-3">
	<div class="col-md-3">
		<label class="form-label">Filter UT-Daerah</label>
		<select class="form-select" v-model="selectedUpbjj">
			<option value="">Semua UT-Daerah</option>
			<option v-for="u in upbjjList" :key="u" :value="u">{{ u }}</option>
		</select>
	</div>
	<div class="col-md-3">
		<label class="form-label">Filter Kategori Mata Kuliah</label>
		<select class="form-select" v-model="selectedKategori">
			<option value="">Semua Kategori</option>
			<option v-for="k in kategoriList" :key="k" :value="k">{{ k }}</option>
		</select>
	</div>
	<div class="col-md-3">
		<label class="form-label">Filter Stok Menipis / Kosong</label>
		<div class="form-check">
			<input class="form-check-input" type="checkbox" id="filterLowStock" v-model="filterLowStock">
			<label class="form-check-label" for="filterLowStock">Tampilkan Stok Menipis / Kosong</label>
		</div>
	</div>
	<div class="col-md-3">
		<label class="form-label">Sort Berdasarkan</label>
		<div class="form-check">
			<input class="form-check-input" type="radio" name="sortBy" id="sortJudul" value="judul" v-model="sortBy">
			<label class="form-check-label" for="sortJudul">Judul</label>
		</div>
		<div class="form-check">
			<input class="form-check-input" type="radio" name="sortBy" id="sortQty" value="qty" v-model="sortBy">
			<label class="form-check-label" for="sortQty">Stok (qty)</label>
		</div>
		<div class="form-check">
			<input class="form-check-input" type="radio" name="sortBy" id="sortHarga" value="harga" v-model="sortBy">
			<label class="form-check-label" for="sortHarga">Harga</label>
		</div>
	</div>
</div>	

<div class="table-responsive">
	<table class="table table-bordered table-hover table-striped">
		<thead>
			<th>Kode</th><th>Judul</th><th>Kategori</th><th>UPBJJ</th><th>Lokasi Rak</th><th>Harga</th><th>Stok</th><th>Batas Stok Aman</th><th>Status</th><th>---</th>
		</thead>
		<tbody>
			<tr v-for="item in filteredItems" :key="item.kode">
				<td>{{ item.kode }}</td>
				<td>
					<a @click.prevent="editItem(item)">{{ item.judul }}</a>
					<i v-if="item.catatanHTML" class="fas fa-question-circle ms-2 text-info" tabindex="0" role="button" v-bind:data-bs-toggle="'popover'" v-bind:data-bs-content="item.catatanHTML" data-bs-html="true" data-bs-title="Catatan" data-bs-placement="right" data-bs-trigger="focus"></i>
				</td>
				<td>{{ item.kategori }}</td>
				<td>{{ item.upbjj }}</td>
				<td>{{ item.lokasiRak }}</td>
				<td>{{ $formatRupiah(item.harga) }}</td>
				<td>{{ formatNumber(item.qty) }} buah</td>
				<td>{{ formatNumber(item.safety) }} buah</td>
				<!-- render badge HTML yang dikembalikan statusBadge -->
				<td v-html="statusBadge(item)"></td>
				<td>
					<div class="btn-group" role="group">
						<button class="btn btn-primary" @click="editItem(item)"><i class="fas fa-edit"></i></button>
						<button class="btn btn-danger" @click="deleteItem(item)"><i class="fas fa-trash"></i></button>
					</div>
				</td>
			</tr>
			<tr v-if="filteredItems.length === 0">
				<td colspan="10" class="text-center">Tidak ada data</td>
			</tr>
		</tbody>
	</table>
</div>

<!-- Modal Add -->
<!-- Teleport Add Modal + Backdrop ke body -->
<teleport to="body">
	<transition name="modal">
		<div v-if="showAddModal" class="modal fade show" data-bs-backdrop="static" aria-modal="true" role="dialog" style="display:block;">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Tambah Bahan Ajar</h5>
						<button type="button" class="btn-close" @click="showAddModal = false"></button>
					</div>
					<form @submit.prevent="addItem" novalidate>
						<div class="modal-body">
							<div v-if="showErrMsg" class="alert alert-danger">Kode sudah ada. Gunakan kode lain.</div>
							<div class="mb-3">
								<label class="form-label">Kode</label>
								<input type="text" class="form-control" id="kode-add" v-model="newItem.kode" required>
								<div class="invalid-feedback" id="kode-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Judul</label>
								<input type="text" class="form-control" id="judul-add" v-model="newItem.judul" required>
								<div class="invalid-feedback" id="judul-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Kategori</label>
								<select class="form-select" id="kategori-add" v-model="newItem.kategori">
									<option v-for="k in kategoriList" :key="k" :value="k">{{ k }}</option>
								</select>
								<div class="invalid-feedback" id="kategori-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">UPBJJ</label>
								<select class="form-select" v-model="newItem.upbjj">
									<option v-for="u in upbjjList" :key="u" :value="u">{{ u }}</option>
								</select>
								<div class="invalid-feedback" id="upbjj-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Lokasi Rak</label>
								<input type="text" class="form-control" id="lokasiRak-add" v-model="newItem.lokasiRak">
								<div class="invalid-feedback" id="lokasiRak-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Harga</label>
								<input type="number" class="form-control" v-model.number="newItem.harga">
								<div class="invalid-feedback" id="harga-add-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Stok (qty)</label>
								<div class="input-group">
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(newItem, 'qty', -1)">-</button>
									<input type="number" class="form-control text-center" v-model.number="newItem.qty" required>
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(newItem, 'qty', 1)">+</button>
									<span class="input-group-text">buah</span>
								</div>
							</div>
							<div class="mb-3">
								<label class="form-label">Batas Stok Aman (safety)</label>
								<div class="input-group">
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(newItem, 'safety', -1)">-</button>
									<input type="number" class="form-control text-center" v-model.number="newItem.safety" required>
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(newItem, 'safety', 1)">+</button>
									<span class="input-group-text">buah</span>
								</div>
							</div>
							<div class="mb-3">
								<label class="form-label">Catatan</label>
								<textarea class="form-control" v-model="newItem.catatanHTML"></textarea>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-danger" @click="showAddModal = false"><i class="fas fa-times"></i> Batalkan</button>
							<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Tambah</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</transition>
	<transition name="backdrop-fade">
		<div v-if="showAddModal" class="modal-backdrop fade show"></div>
	</transition>
</teleport>

<!-- Modal Edit -->
<!-- Teleport Edit Modal + Backdrop ke body -->
<teleport to="body">
	<transition name="modal">
		<div v-if="showEditModal" class="modal fade show" data-bs-backdrop="static" aria-modal="true" role="dialog" style="display:block;">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Bahan Ajar</h5>
						<button type="button" class="btn-close" @click="showEditModal = false"></button>
					</div>
					<form @submit.prevent="updateItem" novalidate>
						<div class="modal-body">
							<div v-if="showErrMsg" class="alert alert-danger">Kode sudah ada. Gunakan kode lain.</div>
							<div class="mb-3">
								<label class="form-label">Kode</label>
								<input type="text" class="form-control" id="kode-edit" v-model="currentItem.kode" required>
								<div class="invalid-feedback" id="kode-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Judul</label>
								<input type="text" class="form-control" id="judul-edit" v-model="currentItem.judul" required>
								<div class="invalid-feedback" id="judul-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Kategori</label>
								<select class="form-select" id="kategori-edit" v-model="currentItem.kategori">
									<option v-for="k in kategoriList" :key="k" :value="k">{{ k }}</option>
								</select>
								<div class="invalid-feedback" id="kategori-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">UPBJJ</label>
								<select class="form-select" id="upbjj-edit" v-model="currentItem.upbjj">
									<option v-for="u in upbjjList" :key="u" :value="u">{{ u }}</option>
								</select>
								<div class="invalid-feedback" id="upbjj-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Lokasi Rak</label>
								<input type="text" class="form-control" id="lokasiRak-edit" v-model="currentItem.lokasiRak">
								<div class="invalid-feedback" id="lokasiRak-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Harga</label>
								<input type="number" class="form-control" id="harga-edit" v-model.number="currentItem.harga">
								<div class="invalid-feedback" id="harga-edit-msg"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Stok (qty)</label>
								<div class="input-group">
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(currentItem, 'qty', -1)">-</button>
									<input type="number" class="form-control text-center" v-model.number="currentItem.qty" required>
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(currentItem, 'qty', 1)">+</button>
									<span class="input-group-text">buah</span>
								</div>
							</div>
							<div class="mb-3">
								<label class="form-label">Batas Stok Aman (safety)</label>
								<div class="input-group">
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(currentItem, 'safety', -1)">-</button>
									<input type="number" class="form-control text-center" v-model.number="currentItem.safety" required>
									<button type="button" class="btn btn-outline-secondary" @click="changeQty(currentItem, 'safety', 1)">+</button>
									<span class="input-group-text">buah</span>
								</div>
							</div>
							<div class="mb-3">
								<label class="form-label">Catatan</label>
								<textarea class="form-control" v-model="currentItem.catatanHTML"></textarea>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-danger" @click="showEditModal = false"><i class="fas fa-times"></i> Batalkan</button>
							<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Perbarui</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</transition>
	<transition name="backdrop-fade">
		<div v-if="showEditModal" class="modal-backdrop fade show"></div>
	</transition>
</teleport>